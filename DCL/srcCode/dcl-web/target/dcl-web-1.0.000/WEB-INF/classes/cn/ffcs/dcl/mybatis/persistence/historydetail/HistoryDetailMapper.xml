<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.ffcs.dcl.mybatis.persistence.historydetail.HistoryDetailMapper">
	<resultMap id="BaseResultMap" type="cn.ffcs.dcl.mybatis.domain.historydetail.HistoryDetail">
		<id column="DETAIL_ID" property="detailId" jdbcType="VARCHAR" /> <!--推送详情主键-->
		<result column="NAME" property="name" jdbcType="VARCHAR" /> <!--姓名-->
		<result column="IDCARD" property="idcard" jdbcType="VARCHAR" /> <!--身份证号-->
		<result column="SEX" property="sex" jdbcType="VARCHAR" /> <!--性别-->
		<result column="PARTY" property="party" jdbcType="VARCHAR" /> <!--所属党支部-->
		<result column="TYPE" property="type" jdbcType="VARCHAR" /> <!--人员类型-->
		<result column="PHONE" property="phone" jdbcType="DECIMAL" /> <!--手机号-->
		<result column="NATION" property="nation" jdbcType="VARCHAR" /> <!--民族-->
		<result column="ORGCODE" property="orgcode" jdbcType="VARCHAR" /> <!--地域-->
		<result column="REGION_Code" property="regionCode" jdbcType="VARCHAR" /> <!--所属区域-->
		<result column="REGION_Name" property="regionName" jdbcType="VARCHAR" /> <!--所属区域名称-->
		<result column="ADDR" property="addr" jdbcType="VARCHAR" /> <!--地址-->
		<result column="STATUS" property="status" jdbcType="VARCHAR" /> <!--推送状态-->
		<result column="IS_VALID" property="isValid" jdbcType="VARCHAR" /> <!--数据有效性-->
		<result column="CREATOR" property="creator" jdbcType="DECIMAL" /> <!--创建人ID-->
		<result column="CREATOR_NAME" property="creatorName" jdbcType="VARCHAR" /> <!--创建人姓名-->
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" /> <!--创建时间-->
		<result column="UPDATOR" property="updator" jdbcType="DECIMAL" /> <!--修改人ID-->
		<result column="UPDATOR_NAME" property="updatorName" jdbcType="VARCHAR" /> <!--修改人姓名-->
		<result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP" /> <!--修改时间-->
		<result column="PARENT_ID" property="parentId" jdbcType="VARCHAR" /> <!--修改时间-->
		<result column="PEOPLE_ID" property="peopleId" jdbcType="VARCHAR" /> <!--修改时间-->
	</resultMap>
		
	<!-- 列表（总数） -->	
	<select id="countList"  resultType="java.lang.Long">
		SELECT COUNT(1) FROM 	T_HISTORY_DETAIL t1
		LEFT JOIN T_VOICE_PEOPLE t2 ON t1.people_id = t2.UUID
		<include refid="find_where" />
	</select>
	
	<!-- 列表（分页） -->
	<select id="searchList"  resultMap="BaseResultMap">
		SELECT
		t1.DETAIL_ID,
		t2.name,
		t2.ADDRESS as ADDR,
		t2.TEL as PHONE,
		t2.sex,
		t1.STATUS
		FROM
		T_HISTORY_DETAIL t1
		LEFT JOIN T_VOICE_PEOPLE t2 ON t1.people_id = t2.UUID
		<include refid="find_where" />
		ORDER BY 
			T1.DETAIL_ID DESC
	</select>
	
	<!-- 列表（条件） -->	
	<sql id="find_where">
		<where>
			<if test="name != null and name != ''" >
				<![CDATA[ AND T2.NAME LIKE '%'||#{name,jdbcType=VARCHAR}||'%' ]]>
			</if>
			<if test="regionName != null and regionName != ''" >
				<![CDATA[ AND T1.REGION_NAME = #{regionName,jdbcType=VARCHAR} ]]>
			</if>
			<if test="parentId != null and parentId != ''" >
				<![CDATA[ AND T1.PARENT_ID = #{parentId,jdbcType=VARCHAR} ]]>
			</if>
			<if test="status != null and status != '' " >
				<![CDATA[ AND STATUS=#{status,jdbcType=VARCHAR} ]]>
			</if>
			<if test="id != null and id != '' " >
				<![CDATA[ AND t1.PARENT_ID=#{id,jdbcType=VARCHAR} ]]>
			</if>
			AND T1.IS_VALID = '1'
			AND T2.IS_VALID = '1'
		</where>
	</sql>
	
	<!-- 新增 -->	
	<insert id="insert" parameterType="cn.ffcs.dcl.mybatis.domain.historydetail.HistoryDetail">
		<selectKey keyProperty="detailId" resultType="string" order="BEFORE">
			SELECT SYS_GUID() FROM DUAL
		</selectKey>
		INSERT INTO
			T_HISTORY_DETAIL
		(
			DETAIL_ID,
			PARENT_ID,
			PEOPLE_ID,
			NAME,
			IDCARD,
			SEX,
			PARTY,
			TYPE,
			PHONE,
			NATION,
			ORGCODE,
			ADDR,
			STATUS,
			IS_VALID,
			CREATOR,
			CREATOR_NAME,
			CREATE_TIME,
			UPDATOR,
			UPDATOR_NAME,
			UPDATE_TIME
		) VALUES (
			#{detailId,jdbcType=VARCHAR},
			#{parentId,jdbcType=VARCHAR},
			#{peopleId,jdbcType=VARCHAR},
			#{name,jdbcType=VARCHAR},
			#{idcard,jdbcType=VARCHAR},
			#{sex,jdbcType=VARCHAR},
			#{party,jdbcType=VARCHAR},
			#{type,jdbcType=VARCHAR},
			#{phone,jdbcType=DECIMAL},
			#{nation,jdbcType=VARCHAR},
			#{orgcode,jdbcType=VARCHAR},
			#{addr,jdbcType=VARCHAR},
			#{status,jdbcType=VARCHAR},
			'1',
			#{creator,jdbcType=DECIMAL},
			#{creatorName,jdbcType=VARCHAR},
			sysdate,
			#{updator,jdbcType=DECIMAL},
			#{updatorName,jdbcType=VARCHAR},
			sysdate
		)
	</insert>
	
	<!-- 修改 -->	
	<update id="update" parameterType="cn.ffcs.dcl.mybatis.domain.historydetail.HistoryDetail">
		UPDATE
			T_HISTORY_DETAIL
		<set> 
			<if test="name != null " >
				NAME=#{name,jdbcType=VARCHAR},
			</if>
			<if test="idcard != null " >
				IDCARD=#{idcard,jdbcType=VARCHAR},
			</if>
			<if test="sex != null " >
				SEX=#{sex,jdbcType=VARCHAR},
			</if>
			<if test="party != null " >
				PARTY=#{party,jdbcType=VARCHAR},
			</if>
			<if test="type != null " >
				TYPE=#{type,jdbcType=VARCHAR},
			</if>
			<if test="phone != null " >
				PHONE=#{phone,jdbcType=DECIMAL},
			</if>
			<if test="nation != null " >
				NATION=#{nation,jdbcType=VARCHAR},
			</if>
			<if test="orgcode != null " >
				ORGCODE=#{orgcode,jdbcType=VARCHAR},
			</if>
			<if test="addr != null " >
				ADDR=#{addr,jdbcType=VARCHAR},
			</if>
			<if test="status != null " >
				STATUS=#{status,jdbcType=VARCHAR},
			</if>
			<if test="isValid != null " >
				IS_VALID=#{isValid,jdbcType=VARCHAR},
			</if>
			<if test="creatorName != null " >
				CREATOR_NAME=#{creatorName,jdbcType=VARCHAR},
			</if>
			<if test="updator != null " >
				UPDATOR=#{updator,jdbcType=DECIMAL},
			</if>
			<if test="updatorName != null " >
				UPDATOR_NAME=#{updatorName,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null " >
				PARENT_ID=#{parentId,jdbcType=VARCHAR},
			</if>
		 UPDATE_TIME = sysdate
		</set>
		WHERE
			<if test="detailId != null " >
				DETAIL_ID=#{detailId,jdbcType=VARCHAR}
			</if>
            <if test="pushId != null ">
                PARENT_ID = #{pushId, jdbcType=VARCHAR} AND PHONE=#{phone,jdbcType=DECIMAL}
            </if>
	</update>
	
	<!-- 详情 -->	
	<select id="searchById" parameterType="string"  resultMap="BaseResultMap">
		SELECT
			T.DETAIL_ID,
			T.NAME,
			T.IDCARD,
			T.SEX,
			T.PARTY,
			T.TYPE,
			T.PHONE,
			T.NATION,
			T.ORGCODE,
			T.REGION_CODE,
			T.REGION_NAME,
			T.ADDR,
			T.STATUS,
			T.IS_VALID,
			T.CREATOR,
			T.CREATOR_NAME,
			T.CREATE_TIME,
			T.UPDATOR,
			T.UPDATOR_NAME,
			T.UPDATE_TIME,
		       T.PARENT_ID
		FROM
			T_HISTORY_DETAIL T
		WHERE
			DETAIL_ID= #{detailId,jdbcType=VARCHAR} 
	</select>
	
	<!-- 删除 -->	
	<delete id="delete" parameterType="cn.ffcs.dcl.mybatis.domain.historydetail.HistoryDetail">

		UPDATE
			T_HISTORY_DETAIL
		SET IS_VALID = '0', UPDATE_TIME = SYSDATE, UPDATOR = #{updator,jdbcType=DECIMAL}
		WHERE
			DETAIL_ID IN
		<foreach collection="delList" index="index" item="item" open="(" separator="," close=")">
		#{item,jdbcType=DECIMAL}
		</foreach>
	</delete>


	<delete id="deleteByParentId" parameterType="cn.ffcs.dcl.mybatis.domain.historydetail.HistoryDetail">

		UPDATE
		T_HISTORY_DETAIL
		SET IS_VALID = '0', UPDATE_TIME = SYSDATE, UPDATOR = #{updator,jdbcType=DECIMAL}
		WHERE
		PARENT_ID  =#{parentId,jdbcType=VARCHAR}
	</delete>
</mapper>