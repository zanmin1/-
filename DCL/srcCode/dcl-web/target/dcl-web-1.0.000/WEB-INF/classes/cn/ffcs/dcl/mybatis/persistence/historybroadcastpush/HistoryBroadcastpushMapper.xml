<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.ffcs.dcl.mybatis.persistence.historybroadcastpush.HistoryBroadcastpushMapper">
	<resultMap id="BaseResultMap" type="cn.ffcs.dcl.mybatis.domain.historybroadcastpush.HistoryBroadcastpush">
		<id column="PUSH_ID" property="pushId" jdbcType="VARCHAR" /> <!--推送主键-->
		<result column="SERIAL" property="serial" jdbcType="DECIMAL" /> <!--序号-->
		<result column="SENDTIME" property="sendtime" jdbcType="TIMESTAMP" /> <!--发送时间-->
		<result column="TYPE" property="type" jdbcType="VARCHAR" /> <!--人员类型-->
		<result column="SENDPEOPLE" property="sendpeople" jdbcType="VARCHAR" /> <!--发送人-->
		<result column="RECIPIENT" property="recipient" jdbcType="VARCHAR" /> <!--收信人-->
		<result column="RECIVE_TYPE" property="reciveType" jdbcType="VARCHAR" /> <!--接受类型-->
		<result column="IS_VALID" property="isValid" jdbcType="VARCHAR" /> <!--数据有效性-->
		<result column="CREATOR" property="creator" jdbcType="DECIMAL" /> <!--创建人ID-->
		<result column="REGION_CODE" property="regionCode" jdbcType="DECIMAL" /> <!--所属区域-->
		<result column="REGION_NAME" property="regionName" jdbcType="DECIMAL" /> <!--所属区域名称-->
		<result column="CREATOR_NAME" property="creatorName" jdbcType="VARCHAR" /> <!--创建人姓名-->
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" /> <!--创建时间-->
		<result column="UPDATOR" property="updator" jdbcType="DECIMAL" /> <!--修改人ID-->
		<result column="UPDATOR_NAME" property="updatorName" jdbcType="VARCHAR" /> <!--修改人姓名-->
		<result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP" /> <!--修改时间-->
		<result column="DETAIL_ID" property="detailId" jdbcType="VARCHAR" /> <!--详情id-->
		<result column="URL" property="url" jdbcType="VARCHAR" /> <!--语音url-->
		<result column="TOTAL" property="total" jdbcType="VARCHAR" /> <!--发送总数-->
		<result column="RECEIVED" property="received" jdbcType="VARCHAR" /> <!--接收成功数-->
		<result column="SESSION_ID" property="sessionId" jdbcType="VARCHAR" /> <!--推送方任务标识ID-->
		<result column="LINK_MAN" property="linkMan" jdbcType="VARCHAR" /> <!--推送方用户ID-->
	</resultMap>
		
	<!-- 列表（总数） -->	
	<select id="countList"  resultType="java.lang.Long">
		SELECT COUNT(1) FROM T_HISTORY_BROADCASTPUSH T LEFT JOIN (SELECT
		t1.PARENT_ID,
		LISTAGG(t2.name,',' )WITHIN GROUP (ORDER BY t1.PARENT_ID)   as RECIPIENT
		FROM
		T_HISTORY_DETAIL t1
		LEFT JOIN T_VOICE_PEOPLE t2 ON t2.PEOPLE_ID+'' = t1.PEOPLE_ID
		WHERE
		t1.IS_VALID = '1' AND t2.IS_VALID = '1'
		GROUP BY PARENT_ID) t3
		on t.PUSH_ID=t3.PARENT_ID
		<include refid="find_where" />
	</select>
	
	<!-- 列表（分页） -->	
	<select id="searchList"  resultMap="BaseResultMap">
		SELECT
			T.PUSH_ID,
			T.SERIAL,
			T.SENDTIME,
			T.TYPE,
			T.SENDPEOPLE,
			t3.RECIPIENT,nvl(t3.RECEIVED,0) RECEIVED,  nvl(t3.total,0)total,
			T.RECIVE_TYPE,
			T.IS_VALID,
			T.REGION_CODE,
			T.REGION_NAME,
			T.CREATOR,
			T.CREATOR_NAME,
			T.CREATE_TIME,
			T.UPDATOR,
			T.UPDATOR_NAME,
			T.UPDATE_TIME,
			T.DETAIL_ID,
			T.LINK_MAN,
		       T.url
		FROM
			T_HISTORY_BROADCASTPUSH T LEFT JOIN (SELECT
											t1.PARENT_ID,
											LISTAGG(t2.name,',' )WITHIN GROUP (ORDER BY t1.PARENT_ID)   as RECIPIENT,
											count (case when t1.STATUS='2' then '1' else null end)  as   RECEIVED,
											count(1)  as total
											FROM
											T_HISTORY_DETAIL t1
											LEFT JOIN T_VOICE_PEOPLE t2 ON t2.UUID = t1.PEOPLE_ID
											WHERE
											t1.IS_VALID = '1' AND t2.IS_VALID = '1'
											GROUP BY PARENT_ID) t3
			      on t.PUSH_ID=t3.PARENT_ID
		<include refid="find_where" />
		ORDER BY 
			T.PUSH_ID DESC 
	</select>
	
	<!-- 列表（条件） -->	
	<sql id="find_where">
		<where>
			T.IS_VALID = '1'
			<if test="regionCode != null and regionCode != ''" >
				<![CDATA[ AND T.TYPE = #{type,jdbcType=VARCHAR} ]]>
			</if> 
			<if test="sendpeople != null and sendpeople != ''" >
				<![CDATA[ AND T.SENDPEOPLE LIKE '%' || #{sendpeople,jdbcType=VARCHAR} || '%' ]]>
			</if>
			<if test="recipient != null and recipient != ''" >
				<![CDATA[ AND t3.RECIPIENT LIKE '%' || #{recipient,jdbcType=VARCHAR} || '%' ]]>
			</if>
            <if test="sessionId != null and sessionId != '' ">
                <![CDATA[ AND SESSION_ID LIKE '%' || #{sessionId, jdbcType=VARCHAR} || '%' ]]>
            </if>
		</where>

	</sql>
	
	<!-- 新增 -->	
	<insert id="insert" parameterType="cn.ffcs.dcl.mybatis.domain.historybroadcastpush.HistoryBroadcastpush">
		<selectKey keyProperty="pushId" resultType="string" order="BEFORE">
			SELECT SYS_GUID() FROM DUAL
		</selectKey>
		INSERT INTO
			T_HISTORY_BROADCASTPUSH
		(
			PUSH_ID,
			SERIAL,
			SENDTIME,
			TYPE,
			SENDPEOPLE,
			RECIPIENT,
			RECIVE_TYPE,
			IS_VALID,
			REGION_CODE,
			REGION_NAME,
			CREATOR,
			CREATOR_NAME,
			CREATE_TIME,
			UPDATOR,
			UPDATOR_NAME,
			UPDATE_TIME,
			DETAIL_ID,
		 	URL,
		 	LINK_MAN,
		 	SESSION_ID
		) VALUES (
			#{pushId,jdbcType=VARCHAR},
			#{serial,jdbcType=DECIMAL},
			sysdate,
			#{type,jdbcType=VARCHAR},
			#{sendpeople,jdbcType=VARCHAR},
			#{recipient,jdbcType=VARCHAR},
			#{reciveType,jdbcType=VARCHAR},
			1,
			#{regionCode,jdbcType=VARCHAR},
			#{regionName,jdbcType=VARCHAR},
			#{creator,jdbcType=DECIMAL},
			#{creatorName,jdbcType=VARCHAR},
			sysdate,
			#{updator,jdbcType=DECIMAL},
			#{updatorName,jdbcType=VARCHAR},
			sysdate,
			#{detailId,jdbcType=VARCHAR},
			#{url,jdbcType=VARCHAR},
			#{linkMan,jdbcType=VARCHAR},
			#{sessionId,jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 修改 -->	
	<update id="update" parameterType="cn.ffcs.dcl.mybatis.domain.historybroadcastpush.HistoryBroadcastpush">
		UPDATE
			T_HISTORY_BROADCASTPUSH
		<set> 
			<if test="serial != null " >
				SERIAL=#{serial,jdbcType=DECIMAL},
			</if>
			<if test="sendtime != null " >
				SENDTIME=#{sendtime,jdbcType=TIMESTAMP},
			</if>
			<if test="type != null " >
				TYPE=#{type,jdbcType=VARCHAR},
			</if>
			<if test="sendpeople != null " >
				SENDPEOPLE=#{sendpeople,jdbcType=VARCHAR},
			</if>
			<if test="recipient != null " >
				RECIPIENT=#{recipient,jdbcType=VARCHAR},
			</if>
			<if test="reciveType != null " >
				RECIVE_TYPE=#{reciveType,jdbcType=VARCHAR},
			</if>
			<if test="isValid != null " >
				IS_VALID=#{isValid,jdbcType=VARCHAR},
			</if>
			<if test="regionCode != null " >
				REGION_CODE=#{regionCode,jdbcType=VARCHAR},
			</if>
			<if test="regionName != null " >
				REGION_Name=#{regionName,jdbcType=VARCHAR},
			</if>
			<if test="creatorName != null " >
				CREATOR_NAME=#{creatorName,jdbcType=VARCHAR},
			</if>
			<if test="updator != null " >
				UPDATOR=#{updator,jdbcType=DECIMAL},
			</if>
			<if test="updatorName != null " >
				UPDATOR_NAME=#{updatorName,jdbcType=VARCHAR},
			</if>
			<if test="detailId != null " >
				DETAIL_ID=#{detailId,jdbcType=VARCHAR},
			</if>
		 UPDATE_TIME = sysdate
		</set>
		WHERE
            <if test="pushId != null ">
                PUSH_ID = #{pushId, jdbcType=VARCHAR}
            </if>
            <if test="sessionId != null ">
                SESSION_ID LIKE '%' || #{sessionId, jdbcType=VARCHAR} || '%'
            </if>
	</update>
	
	<!-- 详情 -->	
	<select id="searchById" parameterType="long"  resultMap="BaseResultMap">
		SELECT
			T.PUSH_ID,
			T.SERIAL,
			T.SENDTIME,
			T.TYPE,
			T.SENDPEOPLE,
			T.RECIPIENT,
			T.RECIVE_TYPE,
			T.IS_VALID,
			T.REGION_CODE,
			T.REGION_NAME,
			T.CREATOR,
			T.CREATOR_NAME,
			T.CREATE_TIME,
			T.UPDATOR,
			T.UPDATOR_NAME,
			T.UPDATE_TIME,
			T.DETAIL_ID,
			T.LINK_MAN
		FROM
			T_HISTORY_BROADCASTPUSH T
		WHERE
			PUSH_ID= #{pushId,jdbcType=VARCHAR} 
	</select>
	
	<!-- 删除 -->	
	<delete id="delete" parameterType="cn.ffcs.dcl.mybatis.domain.historybroadcastpush.HistoryBroadcastpush">
		UPDATE
			T_HISTORY_BROADCASTPUSH
		SET IS_VALID = '0', UPDATE_TIME = SYSDATE, UPDATOR = #{updator,jdbcType=DECIMAL}
		WHERE
			PUSH_ID IN
		<foreach collection="delList" index="index" item="item" open="(" separator="," close=")">
			#{item,jdbcType=DECIMAL}
		</foreach>
	</delete>
</mapper>